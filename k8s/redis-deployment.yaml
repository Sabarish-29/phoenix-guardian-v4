# Phoenix Guardian - Redis Deployment
# Redis with Sentinel for high availability
# Version: 1.0.0
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
  namespace: phoenix-guardian
  labels:
    app.kubernetes.io/name: phoenix-guardian
    app.kubernetes.io/component: redis
    app.kubernetes.io/tier: cache
    app.kubernetes.io/version: "7.2"
spec:
  serviceName: redis-headless
  replicas: 3  # 1 master + 2 replicas
  podManagementPolicy: OrderedReady
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: phoenix-guardian
      app.kubernetes.io/component: redis
  template:
    metadata:
      labels:
        app.kubernetes.io/name: phoenix-guardian
        app.kubernetes.io/component: redis
        app.kubernetes.io/tier: cache
    spec:
      serviceAccountName: phoenix-guardian
      
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        fsGroup: 999
        seccompProfile:
          type: RuntimeDefault
      
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: phoenix-guardian
                  app.kubernetes.io/component: redis
              topologyKey: kubernetes.io/hostname
      
      containers:
        - name: redis
          image: redis:7.2-alpine
          imagePullPolicy: IfNotPresent
          
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          
          ports:
            - name: redis
              containerPort: 6379
              protocol: TCP
          
          command:
            - redis-server
          args:
            - /etc/redis/redis.conf
            - --requirepass
            - $(REDIS_PASSWORD)
          
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: password
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 1Gi
          
          readinessProbe:
            exec:
              command:
                - sh
                - -c
                - redis-cli -a $REDIS_PASSWORD ping | grep PONG
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3
          
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - redis-cli -a $REDIS_PASSWORD ping | grep PONG
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          
          volumeMounts:
            - name: redis-data
              mountPath: /data
            - name: redis-config
              mountPath: /etc/redis
            - name: tmp
              mountPath: /tmp
        
        # Sentinel sidecar for HA
        - name: sentinel
          image: redis:7.2-alpine
          imagePullPolicy: IfNotPresent
          
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          
          ports:
            - name: sentinel
              containerPort: 26379
              protocol: TCP
          
          command:
            - redis-sentinel
          args:
            - /etc/redis/sentinel.conf
          
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: password
          
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
          
          readinessProbe:
            exec:
              command:
                - sh
                - -c
                - redis-cli -p 26379 ping | grep PONG
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
          
          volumeMounts:
            - name: sentinel-config
              mountPath: /etc/redis
            - name: tmp
              mountPath: /tmp
      
      volumes:
        - name: redis-config
          configMap:
            name: redis-config
        - name: sentinel-config
          configMap:
            name: redis-sentinel-config
        - name: tmp
          emptyDir: {}
      
      terminationGracePeriodSeconds: 30
  
  volumeClaimTemplates:
    - metadata:
        name: redis-data
        labels:
          app.kubernetes.io/name: phoenix-guardian
          app.kubernetes.io/component: redis
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 10Gi

---
# Headless service for StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: redis-headless
  namespace: phoenix-guardian
  labels:
    app.kubernetes.io/name: phoenix-guardian
    app.kubernetes.io/component: redis
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
    - name: sentinel
      port: 26379
      targetPort: 26379
  selector:
    app.kubernetes.io/name: phoenix-guardian
    app.kubernetes.io/component: redis

---
# Service for application access
apiVersion: v1
kind: Service
metadata:
  name: redis-service
  namespace: phoenix-guardian
  labels:
    app.kubernetes.io/name: phoenix-guardian
    app.kubernetes.io/component: redis
spec:
  type: ClusterIP
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
  selector:
    app.kubernetes.io/name: phoenix-guardian
    app.kubernetes.io/component: redis

---
# Redis ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-config
  namespace: phoenix-guardian
  labels:
    app.kubernetes.io/name: phoenix-guardian
    app.kubernetes.io/component: redis
data:
  redis.conf: |
    # Redis configuration
    bind 0.0.0.0
    port 6379
    
    # Persistence
    dir /data
    appendonly yes
    appendfsync everysec
    
    # Memory
    maxmemory 512mb
    maxmemory-policy allkeys-lru
    
    # Security
    protected-mode yes
    
    # Performance
    tcp-keepalive 300
    timeout 0
    tcp-backlog 511
    databases 16
    
    # Replication
    replica-read-only yes
    replica-serve-stale-data yes
    
    # Logging
    loglevel notice

---
# Sentinel ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-sentinel-config
  namespace: phoenix-guardian
  labels:
    app.kubernetes.io/name: phoenix-guardian
    app.kubernetes.io/component: redis
data:
  sentinel.conf: |
    port 26379
    sentinel monitor mymaster redis-0.redis-headless.phoenix-guardian.svc.cluster.local 6379 2
    sentinel down-after-milliseconds mymaster 5000
    sentinel failover-timeout mymaster 60000
    sentinel parallel-syncs mymaster 1

---
# Pod Disruption Budget
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: redis-pdb
  namespace: phoenix-guardian
  labels:
    app.kubernetes.io/name: phoenix-guardian
    app.kubernetes.io/component: redis
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: phoenix-guardian
      app.kubernetes.io/component: redis
